<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>차량 주차 정보 조회</title>

<style>
body {
    font-family: Arial, sans-serif;
    background: #f4f6fa;
    margin: 0;
    padding: 30px 0;
}

.container {
    max-width: 900px;
    margin: 0 auto;
    background: #fff;
    padding: 24px;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.header { display: flex; align-items: center; gap: 16px; margin-bottom: 20px; }
.header h2 { margin: 0; font-size: 20px; }
.header input { padding: 8px 10px; font-size: 14px; width: 140px; }
.header button { padding: 8px 14px; font-size: 14px; cursor: pointer; }

.main { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }
.card { border: 1px solid #ddd; border-radius: 8px; padding: 16px; }
.card h3 { margin-top:0;margin-bottom:12px;font-size:16px;border-bottom:1px solid #eee;padding-bottom:6px; }
.info-row { display:flex; justify-content:space-between; margin-bottom:10px; font-size:14px; }
.info-label { color:#555; }
.info-value { font-weight:bold; }
canvas { width:100%; height:200px; border:1px solid #ccc; border-radius:6px; }

.log { border-top:2px solid #eee; padding-top:20px; }
table { width:100%; border-collapse:collapse; }
th { background:#f0f2f7; padding:10px; font-size:13px; }
td { padding:12px 8px; text-align:center; font-size:13px; line-height:1.6; border-bottom:1px solid #ddd; }
tbody tr:hover { background:#eef2ff; }
</style>
</head>

<body>
<div class="container">

<div class="header">
    <h2>차량 주차 정보</h2>
    <input id="prefix" placeholder="차량 ID 앞 4자리">
    <button onclick="search()">조회</button>
</div>

<div class="main">
    <div class="card" id="currentInfo">
        <h3>현재 차량 정보</h3>
        <div class="info-row"><span class="info-label">차량 ID</span><span class="info-value" id="cid">-</span></div>
        <div class="info-row"><span class="info-label">상태</span><span class="info-value" id="state">-</span></div>
        <div class="info-row"><span class="info-label">입차 시간</span><span class="info-value" id="enter">-</span></div>
        <div class="info-row" id="feeRow" style="display:none;"><span class="info-label">현재 요금</span><span class="info-value" id="fee">-</span></div>
    </div>

    <div class="card">
        <h3>요금 변화 (점 그래프)</h3>
        <canvas id="graph" width="400" height="200"></canvas>
    </div>
</div>

<div class="log">
    <h3>출입 로그</h3>
    <table>
        <thead><tr><th>날짜</th><th>시간</th><th>상태</th><th>요금</th></tr></thead>
        <tbody id="logBody"></tbody>
    </table>
</div>

</div>

<script>
async function search() {
    const prefix = document.getElementById("prefix").value.trim();
    if (!prefix) return;

    try {
        const res = await fetch(`http://10.10.141.78/car_info.php?prefix=${prefix}`);
        const data = await res.json();

        if (!data.current) {
            alert("차량 정보 없음");
            return;
        }

        // 1. 현재 정보 업데이트
        document.getElementById("cid").textContent = data.current.id;
        document.getElementById("state").textContent = data.current.state === 1 ? "주차 중" : "출차";
        document.getElementById("enter").textContent = data.current.enter_time ?? "-";

        if (data.current.fee !== null) {
            document.getElementById("feeRow").style.display = "flex";
            document.getElementById("fee").textContent = data.current.fee.toLocaleString() + " 원";
        } else {
            document.getElementById("feeRow").style.display = "none";
        }

        // 2. 로그 테이블 채우기 및 일별 합계 계산
        const body = document.getElementById("logBody");
        body.innerHTML = "";

        // 날짜별 요금 합계를 저장할 객체
        const dailyTotal = {};

        data.logs.forEach(log => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${log.date}</td>
                <td>${log.time}</td>
                <td>${log.state === "ENTER" ? "입차" : "출차"}</td>
                <td>${log.fee === null ? "-" : log.fee.toLocaleString() + " 원"}</td>
            `;
            body.appendChild(tr);

            // 요금이 있는 경우 해당 날짜에 합산
            if (log.fee !== null) {
                const dateKey = log.date; // "2023-10-27" 형태
                dailyTotal[dateKey] = (dailyTotal[dateKey] || 0) + log.fee;
            }
        });

        // 3. 그래프용 데이터 정제 (날짜순 정렬)
        const sortedDates = Object.keys(dailyTotal).sort();
        const points = sortedDates.map((date, index) => ({
            x: index,
            y: dailyTotal[date]
        }));
        const labels = sortedDates.map(date => date.substring(5).replace("-", "/")); // "10/27"

        drawGraph(points, labels);

    } catch (err) {
        console.error(err);
        alert("데이터를 가져오는 중 오류 발생");
    }
}

function drawGraph(points, labels) {
    const c = document.getElementById("graph");
    const ctx = c.getContext("2d");
    ctx.clearRect(0, 0, c.width, c.height);

    const marginLeft = 60, marginBottom = 30; // 요금이 커질 수 있어 왼쪽 여백 확보
    const graphWidth = c.width - marginLeft - 30;
    const graphHeight = c.height - 20 - marginBottom;

    if (points.length === 0) return;

    // 최대값 설정 (최소 10,000원 단위로 눈금 생성)
    const maxY = Math.max(...points.map(p => p.y), 10000);
    
    // 축 그리기
    ctx.strokeStyle = "#888";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(marginLeft, 10);
    ctx.lineTo(marginLeft, 10 + graphHeight);
    ctx.lineTo(marginLeft + graphWidth, 10 + graphHeight);
    ctx.stroke();

    // Y축 눈금 및 라벨
    ctx.fillStyle = "#888";
    ctx.font = "10px Arial";
    ctx.textAlign = "right";
    const gridCount = 5;
    for (let i = 0; i <= gridCount; i++) {
        const val = Math.round((maxY / gridCount) * i);
        const yPos = 10 + graphHeight - (val / maxY * graphHeight);
        ctx.fillText(val.toLocaleString(), marginLeft - 8, yPos + 4);
    }

    const xStep = points.length > 1 ? graphWidth / (points.length - 1) : 0;
    const getX = (i) => points.length > 1 ? marginLeft + i * xStep : marginLeft + (graphWidth / 2);
    const getY = (val) => 10 + graphHeight - (val / maxY * graphHeight);

    // 선 그리기
    if (points.length > 1) {
        ctx.strokeStyle = "#1f6feb";
        ctx.lineWidth = 2;
        ctx.beginPath();
        points.forEach((p, i) => {
            if (i === 0) ctx.moveTo(getX(i), getY(p.y));
            else ctx.lineTo(getX(i), getY(p.y));
        });
        ctx.stroke();
    }

    // 데이터 점 및 X축 라벨
    points.forEach((p, i) => {
        const xPos = getX(i);
        const yPos = getY(p.y);

        // 점
        ctx.fillStyle = "#1f6feb";
        ctx.beginPath();
        ctx.arc(xPos, yPos, 4, 0, Math.PI * 2);
        ctx.fill();

        // 라벨
        ctx.fillStyle = "#888";
        ctx.textAlign = "center";
        ctx.fillText(labels[i], xPos, 10 + graphHeight + 15);
    });
}
</script>

</body>
</html>
